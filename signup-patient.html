<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Role</title>
  <link rel="stylesheet" href="css/signup.css">
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="main">  	
    <input type="checkbox" id="chk" aria-hidden="true">

    <div class="signup">
      <form id="patient-signup-form">
        <label for="chk" aria-hidden="true">Sign up</label>
        
        <input type="text" name="patient_name" placeholder="Patient Name" required>
        
        <select name="gender" required>
          <option value="" disabled selected>Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
        
        <input type="email" name="email" placeholder="Email Address" required>
        <input type="tel" name="contact" placeholder="Contact No" required>
        <input type="date" name="dob" placeholder="Date of Birth" required>
        <input type="text" name="address" placeholder="Address" required>
        <input type="text" name="city" placeholder="City" required>
        <input type="text" name="state" placeholder="State" required>
        <input type="password" name="password" placeholder="Password" required>
        
        <button type="submit">Sign up</button>
      </form>
    </div>

    <div class="login">
      <form id="patient-login-form">
        <label for="chk" aria-hidden="true">Login</label>
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>
    </div>
  </div>
</body>


<script>
// fetch csrf token from Django-served endpoint(from backend)
async function getCsrfToken() {
    const res = await fetch("https://emergency-response-aeh2.onrender.com/api/csrf/", {
        credentials: 'include' // <-- Add this
    });
    const data = await res.json();
    return data.csrftoken;
}


// Patient Signup Fetch
document.getElementById('patient-signup-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = {
        patient_name: form.patient_name.value,
        gender: form.gender.value,
        email: form.email.value,
        contact: form.contact.value,
        dob: form.dob.value,
        address: form.address.value,
        city: form.city.value,
        state: form.state.value,
        password: form.password.value
    };

    try {
        const csrfToken = await getCsrfToken(); // Fetch the token before the POST request

        const response = await fetch("https://emergency-response-aeh2.onrender.com/api/signup/patient/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken // Use the fetched token here
            },
            body: JSON.stringify(formData),
            credentials: 'include' // <-- Add this to all POST requests

        });

        const result = await response.json();
        alert(result.message || 'Signup complete!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
});


// Login Fetch (same file)
// NOTE: I am assuming your patient-login-form ID is now fixed.
document.getElementById('patient-login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const loginData = {
        email: form.email.value,
        password: form.password.value // Corrected the password field name to match the form
    };

    try {
        const csrfToken = await getCsrfToken(); // Fetch the token for login as well

        const res = await fetch("https://emergency-response-aeh2.onrender.com/api/login/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken // Use the fetched token here
            },
            body: JSON.stringify(loginData),
            credentials: 'include'
        });
        const result = await res.json();
        alert(result.message || 'Login successful!');
        // Redirect based on role if needed
        // window.location.href = '/patient-profile.html';
    } catch (err) {
        alert('Login failed: ' + err.message);
    }
});
</script>







</html>
