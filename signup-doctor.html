<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Doctor Signup/Login</title>
  <link rel="stylesheet" href="css/signup.css">
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="main">
    <input type="checkbox" id="chk" aria-hidden="true">

    <div class="signup">
      <form id="doctor-signup-form">
        <label for="chk" aria-hidden="true">Sign up</label>
        <input type="text" name="name" placeholder="Doctor Name" required>
        <select name="gender" required>
          <option value="" disabled selected>Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
        <input type="text" name="department" placeholder="Field/Department" required>
        <input type="text" name="appointment" placeholder="Title" required>
        <input type="tel" name="contact" placeholder="Contact Number" required>
        <input type="email" name="email" placeholder="Email Address" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Sign up</button>
      </form>
    </div>

    <div class="login">
      <form id="doctor-login-form">
        <label for="chk" aria-hidden="true">Login</label>
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Login</button>
      </form>
    </div>
  </div>
</body>

<script>
  // Fetches CSRF token from the Django backend
  async function getCsrfToken() {
    try {
      const res = await fetch("https://emergency-response-aeh2.onrender.com/api/csrf/", {
        credentials: 'include'
      });
      if (!res.ok) {
        throw new Error('Failed to fetch CSRF token');
      }
      const data = await res.json();
      return data.csrftoken;
    } catch (error) {
      console.error("Error fetching CSRF token:", error);
      return null;
    }
  }

  // Doctor Signup Form Submission
  document.getElementById('doctor-signup-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = {
      name: form.name.value,
      gender: form.gender.value,
      department: form.department.value,
      appointment: form.appointment.value,
      contact: form.contact.value,
      email: form.email.value,
      password: form.password.value
    };

    try {
      const csrfToken = await getCsrfToken();
      if (!csrfToken) {
        alert('Could not get CSRF token. Signup failed.');
        return;
      }

      const res = await fetch("https://emergency-response-aeh2.onrender.com/api/signup/doctor/", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(formData),
        credentials: 'include'
      });
      const result = await res.json();
      if (res.ok) {
        alert(result.message || 'Doctor signup successful!');
      } else {
        alert('Signup failed: ' + (result.message || res.statusText));
      }
    } catch (err) {
      alert('Signup failed: ' + err.message);
    }
  });

  // Doctor Login Form Submission
  document.getElementById('doctor-login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const loginData = {
      email: form.email.value,
      password: form.password.value // Corrected this line
    };

    try {
      const csrfToken = await getCsrfToken();
      if (!csrfToken) {
        alert('Could not get CSRF token. Login failed.');
        return;
      }
      
      const res = await fetch("https://emergency-response-aeh2.onrender.com/api/login/", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(loginData)
        credentials: 'include'
      });
      const result = await res.json();
      if (res.ok) {
        alert(result.message || 'Login successful!');
      } else {
        alert('Login failed: ' + (result.message || res.statusText));
      }
    } catch (err) {
      alert('Login failed: ' + err.message);
    }
  });
</script>
</html>